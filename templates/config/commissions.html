{% extends "base.html" %}

{% block content %}
<div class="commission-settings">
    <h1>Gestión de Comisiones</h1>
    
    <div class="commission-section">
        <h2>Comisiones por Producto</h2>
        <div class="table-container">
            <table class="commission-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Comisión Estándar (%)</th>
                        <th>Sobrecomisión</th>
                        <th>Porcentaje Sobrecomisión (%)</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>{{ product.name }}</td>
                        <td>
                            <input type="number" 
                                   class="commission-input" 
                                   value="{{ product.commission_percentage }}"
                                   min="0" 
                                   max="100" 
                                   step="0.01"
                                   data-product-id="{{ product.id }}">
                        </td>
                        <td>
                            <input type="checkbox" 
                                   class="sobrecomision-toggle"
                                   {% if product.sobrecomision %}checked{% endif %}
                                   data-product-id="{{ product.id }}">
                        </td>
                        <td>
                            <input type="number" 
                                   class="override-input" 
                                   value="{{ product.override_percentage }}"
                                   min="0" 
                                   max="100" 
                                   step="0.01"
                                   data-product-id="{{ product.id }}"
                                   {% if not product.sobrecomision %}disabled{% endif %}>
                        </td>
                        <td>
                            <button class="btn btn-primary save-commission" 
                                    data-product-id="{{ product.id }}">
                                Guardar
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="commission-section mt-5">
        <h2>Comisiones Personalizadas por Agente</h2>
        <div class="table-container">
            <table class="commission-table">
                <thead>
                    <tr>
                        <th>Agente</th>
                        <th>Producto</th>
                        <th>Comisión (%)</th>
                        <th>Sobrecomisión</th>
                        <th>Porcentaje Sobrecomisión (%)</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for agent in agents %}
                    <tr class="agent-commission-row">
                        <td>{{ agent.name }}</td>
                        <td>
                            <select class="product-select" data-agent-id="{{ agent.id }}">
                                {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <input type="number" 
                                   class="commission-input" 
                                   min="0" 
                                   max="100" 
                                   step="0.01"
                                   placeholder="Comisión personalizada">
                        </td>
                        <td>
                            <input type="checkbox" 
                                   class="agent-sobrecomision-toggle">
                        </td>
                        <td>
                            <input type="number" 
                                   class="agent-override-input" 
                                   min="0" 
                                   max="100" 
                                   step="0.01"
                                   disabled
                                   placeholder="Sobrecomisión personalizada">
                        </td>
                        <td>
                            <button class="btn btn-primary save-agent-commission" 
                                    data-agent-id="{{ agent.id }}">
                                Guardar
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejar el toggle de sobrecomisión
    document.querySelectorAll('.sobrecomision-toggle').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const row = this.closest('tr');
            const overrideInput = row.querySelector('.override-input');
            
            if (this.checked) {
                overrideInput.removeAttribute('disabled');
                overrideInput.classList.add('enabled');
            } else {
                overrideInput.setAttribute('disabled', 'disabled');
                overrideInput.classList.remove('enabled');
                overrideInput.value = '0';
            }
        });
        
        // Inicializar estado
        checkbox.dispatchEvent(new Event('change'));
    });

    // Manejar guardado de comisiones
    document.querySelectorAll('.save-commission').forEach(function(button) {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            const row = this.closest('tr');
            const commissionInput = row.querySelector('.commission-input');
            const sobrecomisionToggle = row.querySelector('.sobrecomision-toggle');
            const overrideInput = row.querySelector('.override-input');
            
            fetch('/config/commissions/product/' + productId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'commission_percentage': commissionInput.value,
                    'sobrecomision': sobrecomisionToggle.checked,
                    'override_percentage': overrideInput.value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage('success', 'Comisión actualizada exitosamente');
                } else {
                    showMessage('error', 'Error al actualizar la comisión: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('error', 'Error al actualizar la comisión');
            });
        });
    });

    // Nuevo código para comisiones por agente
    document.querySelectorAll('.agent-sobrecomision-toggle').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const row = this.closest('tr');
            const overrideInput = row.querySelector('.agent-override-input');
            
            if (this.checked) {
                overrideInput.removeAttribute('disabled');
            } else {
                overrideInput.setAttribute('disabled', 'disabled');
                overrideInput.value = '0';
            }
        });
    });

    // Cargar valores de comisión al cambiar el producto
    document.querySelectorAll('.product-select').forEach(function(select) {
        select.addEventListener('change', function() {
            const agentId = this.dataset.agentId;
            const productId = this.value;
            const row = this.closest('tr');
            
            fetch(`/config/commissions/override/${agentId}/${productId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const commissionInput = row.querySelector('.commission-input');
                        const sobrecomisionToggle = row.querySelector('.agent-sobrecomision-toggle');
                        const overrideInput = row.querySelector('.agent-override-input');
                        
                        if (data.commission_percentage !== null) {
                            commissionInput.value = data.commission_percentage;
                            sobrecomisionToggle.checked = data.sobrecomision;
                            overrideInput.value = data.override_percentage;
                            overrideInput.disabled = !data.sobrecomision;
                        } else {
                            commissionInput.value = '';
                            sobrecomisionToggle.checked = false;
                            overrideInput.value = '0';
                            overrideInput.disabled = true;
                        }
                    }
                });
        });
        
        // Cargar valores iniciales
        select.dispatchEvent(new Event('change'));
    });

    // Guardar comisiones personalizadas por agente
    document.querySelectorAll('.save-agent-commission').forEach(function(button) {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            const agentId = this.dataset.agentId;
            const productId = row.querySelector('.product-select').value;
            const commissionInput = row.querySelector('.commission-input');
            const sobrecomisionToggle = row.querySelector('.agent-sobrecomision-toggle');
            const overrideInput = row.querySelector('.agent-override-input');
            
            fetch('/config/commissions/override', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'agent_id': agentId,
                    'product_id': productId,
                    'commission_percentage': commissionInput.value,
                    'sobrecomision': sobrecomisionToggle.checked,
                    'override_percentage': overrideInput.value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage('success', 'Comisión personalizada guardada exitosamente');
                } else {
                    showMessage('error', 'Error al guardar la comisión personalizada');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('error', 'Error al guardar la comisión personalizada');
            });
        });
    });
});

function showMessage(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `;
    
    document.querySelector('.commission-settings').insertAdjacentElement('afterbegin', alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>
{% endblock %}
{% endblock %}
