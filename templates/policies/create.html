{% extends "base.html" %}

{% block content %}
<div class="form-container">
    <div class="form-header">
        <h1>Crear Nueva Póliza</h1>
        <p class="form-subtitle">Ingrese la información de la nueva póliza</p>
    </div>

    <form method="POST" class="modern-form">
        {{ form.hidden_tag() }}
        
        <div class="form-grid">
            <div class="form-section">
                <h3>Información Básica</h3>
                <div class="input-group">
                    <div class="form-field">
                        {{ form.policy_number.label }}
                        {{ form.policy_number(class="modern-input") }}
                        {% for error in form.policy_number.errors %}
                            <span class="error-message">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="form-field">
                        {{ form.product_id.label }}
                        {{ form.product_id(class="modern-input select-input") }}
                        {% for error in form.product_id.errors %}
                            <span class="error-message">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Fechas y Valores</h3>
                <div class="input-group">
                    <div class="form-field">
                        {{ form.start_date.label }}
                        {{ form.start_date(class="modern-input", type="date") }}
                        {% for error in form.start_date.errors %}
                            <span class="error-message">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="form-field">
                        {{ form.end_date.label }}
                        {{ form.end_date(class="modern-input", type="date") }}
                        {% for error in form.end_date.errors %}
                            <span class="error-message">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="form-field">
                    {{ form.premium.label }}
                    {{ form.premium(class="modern-input") }}
                    {% for error in form.premium.errors %}
                        <span class="error-message">{{ error }}</span>
                    {% endfor %}
                </div>
            </div>

            <div class="form-section">
                <h3>Participantes</h3>
                <div class="input-group">
                    <div class="form-field">
                        {{ form.client.label }}
                        {{ form.client(class="modern-input", id="client_search") }}
                        {{ form.client_id(id="client_id") }}
                        <div id="client_results" class="search-results"></div>
                        {% for error in form.client.errors %}
                            <span class="error-message">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="form-field">
                        {{ form.agent.label }}
                        {{ form.agent(class="modern-input", id="agent_search") }}
                        {{ form.agent_id(id="agent_id") }}
                        <div id="agent_results" class="search-results"></div>
                        {% for error in form.agent.errors %}
                            <span class="error-message">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Estado</h3>
                <div class="input-group">
                    <div class="form-field">
                        {{ form.emision_status.label }}
                        {{ form.emision_status(class="modern-input select-input") }}
                        {% for error in form.emision_status.errors %}
                            <span class="error-message">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="form-field">
                        {{ form.payment_status.label }}
                        {{ form.payment_status(class="modern-input select-input") }}
                        {% for error in form.payment_status.errors %}
                            <span class="error-message">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <a href="{{ url_for('policies.list_policies') }}" class="btn btn-secondary">Cancelar</a>
            {{ form.submit(class="btn btn-primary") }}
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    function setupSearch(inputId, resultsId, hiddenInputId, searchUrl) {
        const input = document.getElementById(inputId);
        const results = document.getElementById(resultsId);
        const hiddenInput = document.getElementById(hiddenInputId);

        input.addEventListener('input', function() {
            if (this.value.length > 2) {
                fetch(`${searchUrl}?query=${this.value}`)
                    .then(response => response.json())
                    .then(data => {
                        results.innerHTML = '';
                        data.forEach(item => {
                            const div = document.createElement('div');
                            div.textContent = item.name;
                            div.className = 'search-result-item';
                            div.addEventListener('click', function() {
                                input.value = item.name;
                                hiddenInput.value = item.id;
                                results.innerHTML = '';
                            });
                            results.appendChild(div);
                        });
                    });
            } else {
                results.innerHTML = '';
            }
        });

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function(event) {
            if (!event.target.closest(`#${inputId}`) && !event.target.closest(`#${resultsId}`)) {
                results.innerHTML = '';
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        setupSearch('client_search', 'client_results', 'client_id', '{{ url_for("policies.search_clients") }}');
        setupSearch('agent_search', 'agent_results', 'agent_id', '{{ url_for("policies.search_agents") }}');
    });
</script>
{% endblock %}
