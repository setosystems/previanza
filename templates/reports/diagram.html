{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="mb-6">
        <h1 class="page-title">Diagrama de Jerarquía de Agentes</h1>
        <p class="subtitle">Visualización de la estructura organizacional</p>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="section-title flex items-center">
                <i class="fas fa-sitemap text-primary-600 mr-2"></i>
                Estructura Jerárquica
            </h3>
        </div>
        <div class="card-body">
            <div id="tree-container" class="h-[600px] border border-gray-200 rounded-lg overflow-auto p-4"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.node {
    cursor: pointer;
}

.node circle {
    fill: #fff;
    stroke: #0284c7;
    stroke-width: 2px;
}

.node text {
    font: 12px 'Inter', sans-serif;
    fill: #374151;
}

.link {
    fill: none;
    stroke: #e5e7eb;
    stroke-width: 1.5px;
}

.node:hover circle {
    stroke: #0ea5e9;
}

.node.selected circle {
    stroke: #38bdf8;
    stroke-width: 3px;
}

.node:hover text {
    fill: #1f2937;
    font-weight: 500;
}

/* Tooltip */
.node-tooltip {
    position: absolute;
    padding: 0.5rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    pointer-events: none;
    font-size: 0.875rem;
    z-index: 10;
}

.node-tooltip p {
    margin: 0;
    line-height: 1.25;
}

.node-tooltip .name {
    font-weight: 500;
    color: #1f2937;
}

.node-tooltip .role {
    color: #6b7280;
    font-size: 0.75rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuración del diagrama
    const margin = {top: 20, right: 90, bottom: 30, left: 90};
    const width = 960 - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;

    // Crear el contenedor SVG
    const svg = d3.select("#tree-container")
        .append("svg")
        .attr("width", width + margin.right + margin.left)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    // Crear el layout del árbol
    const tree = d3.tree().size([height, width]);

    // Crear tooltip
    const tooltip = d3.select("#tree-container")
        .append("div")
        .attr("class", "node-tooltip")
        .style("opacity", 0);

    // Cargar los datos
    d3.json("{{ url_for('reports.api_agent_hierarchy') }}").then(function(data) {
        // Crear la jerarquía
        const root = d3.hierarchy(data);
        
        // Asignar posiciones a los nodos
        tree(root);

        // Crear los enlaces
        const link = svg.selectAll(".link")
            .data(root.links())
            .enter().append("path")
            .attr("class", "link")
            .attr("d", d3.linkHorizontal()
                .x(d => d.y)
                .y(d => d.x));

        // Crear los nodos
        const node = svg.selectAll(".node")
            .data(root.descendants())
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.y},${d.x})`);

        // Agregar círculos a los nodos
        node.append("circle")
            .attr("r", 6);

        // Agregar texto a los nodos
        node.append("text")
            .attr("dy", ".31em")
            .attr("x", d => d.children ? -13 : 13)
            .style("text-anchor", d => d.children ? "end" : "start")
            .text(d => d.data.name);

        // Agregar interactividad
        node.on("mouseover", function(event, d) {
            d3.select(this).classed("selected", true);
            tooltip.transition()
                .duration(200)
                .style("opacity", .9);
            tooltip.html(`
                <p class="name">${d.data.name}</p>
                <p class="role">${d.data.role}</p>
            `)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", function() {
            d3.select(this).classed("selected", false);
            tooltip.transition()
                .duration(500)
                .style("opacity", 0);
        });

    }).catch(function(error) {
        console.error("Error cargando los datos:", error);
        document.getElementById("tree-container").innerHTML = `
            <div class="flex items-center justify-center h-full">
                <div class="text-center">
                    <i class="fas fa-exclamation-circle text-danger-500 text-4xl mb-4"></i>
                    <p class="text-gray-700">Error al cargar el diagrama. Por favor, intente más tarde.</p>
                </div>
            </div>`;
    });
});
</script>
{% endblock %}
