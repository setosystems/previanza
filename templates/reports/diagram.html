{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="mb-6">
        <h1 class="page-title">Diagrama de Jerarquía de Agentes</h1>
        <p class="subtitle">Visualización de la estructura organizacional</p>
    </div>

    {% if error_message %}
    <div class="bg-red-50 p-4 rounded-lg mb-6">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-circle text-red-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">Error</h3>
                <p class="text-sm text-red-700">{{ error_message }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header">
            <h3 class="section-title flex items-center">
                <i class="fas fa-sitemap text-primary-600 mr-2"></i>
                Estructura Jerárquica
            </h3>
        </div>
        <div class="card-body">
            <div id="tree-container" class="h-[600px] border border-gray-200 rounded-lg overflow-auto p-4">
                <!-- El diagrama se renderizará aquí -->
                <div id="loading" class="flex items-center justify-center h-full">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.node {
    cursor: pointer;
}

.node circle {
    fill: #fff;
    stroke: #0284c7;
    stroke-width: 2px;
}

.node text {
    font: 12px 'Inter', sans-serif;
    fill: #374151;
}

.link {
    fill: none;
    stroke: #e5e7eb;
    stroke-width: 1.5px;
}

.node:hover circle {
    stroke: #0ea5e9;
}

.node.selected circle {
    stroke: #38bdf8;
    stroke-width: 3px;
}

.node:hover text {
    fill: #1f2937;
    font-weight: 500;
}

/* Tooltip */
.node-tooltip {
    position: absolute;
    padding: 0.5rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    pointer-events: none;
    font-size: 0.875rem;
    z-index: 10;
}

.node-tooltip p {
    margin: 0;
    line-height: 1.25;
}

.node-tooltip .name {
    font-weight: 500;
    color: #1f2937;
}

.node-tooltip .role {
    color: #6b7280;
    font-size: 0.75rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const treeContainer = document.getElementById('tree-container');
    const loading = document.getElementById('loading');

    fetch("{{ url_for('reports.agent_hierarchy_data') }}")
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al cargar los datos');
            }
            return response.json();
        })
        .then(data => {
            loading.style.display = 'none';
            if (data.error) {
                throw new Error(data.error);
            }
            renderTree(data);
        })
        .catch(error => {
            loading.style.display = 'none';
            treeContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-gray-500">
                    <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
                    <p>${error.message || 'Error al cargar el diagrama'}</p>
                </div>
            `;
        });
});

function renderTree(data) {
    // Limpiar el contenedor
    const container = document.getElementById('tree-container');
    container.innerHTML = '';

    // Configuración del diagrama
    const margin = {top: 20, right: 90, bottom: 30, left: 90};
    const width = container.offsetWidth - margin.left - margin.right;
    const height = container.offsetHeight - margin.top - margin.bottom;

    // Crear el SVG
    const svg = d3.select("#tree-container")
        .append("svg")
        .attr("width", width + margin.right + margin.left)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    // Crear la jerarquía
    const root = d3.hierarchy(data);

    // Configurar el árbol
    const treeLayout = d3.tree()
        .size([height, width - 160]);  // -160 para dar espacio a los nombres

    // Asignar posiciones a los nodos
    treeLayout(root);

    // Crear los enlaces
    const links = svg.selectAll(".link")
        .data(root.links())
        .enter()
        .append("path")
        .attr("class", "link")
        .attr("d", d3.linkHorizontal()
            .x(d => d.y)
            .y(d => d.x));

    // Crear los nodos
    const nodes = svg.selectAll(".node")
        .data(root.descendants())
        .enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${d.y},${d.x})`);

    // Añadir círculos a los nodos
    nodes.append("circle")
        .attr("r", 8)
        .on("mouseover", function(event, d) {
            // Mostrar tooltip
            const tooltip = d3.select("body")
                .append("div")
                .attr("class", "node-tooltip")
                .style("opacity", 0);

            tooltip.transition()
                .duration(200)
                .style("opacity", 1);

            tooltip.html(`
                <p class="name">${d.data.name}</p>
                <p class="role">${d.data.role || 'Agente'}</p>
            `)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", function() {
            d3.selectAll(".node-tooltip").remove();
        });

    // Añadir etiquetas a los nodos
    nodes.append("text")
        .attr("dy", ".31em")
        .attr("x", d => d.children ? -13 : 13)
        .style("text-anchor", d => d.children ? "end" : "start")
        .text(d => d.data.name);

    // Añadir zoom y pan
    const zoom = d3.zoom()
        .scaleExtent([0.5, 2])
        .on("zoom", (event) => {
            svg.attr("transform", event.transform);
        });

    d3.select("#tree-container svg")
        .call(zoom)
        .call(zoom.translateTo, width / 2, height / 2);

    // Centrar el diagrama inicialmente
    const initialScale = 0.8;
    const svgElement = document.querySelector("#tree-container svg");
    const svgWidth = svgElement.clientWidth;
    const svgHeight = svgElement.clientHeight;
    
    d3.select("#tree-container svg")
        .call(zoom.transform, d3.zoomIdentity
            .translate(svgWidth / 4, svgHeight / 4)
            .scale(initialScale));
}
</script>
{% endblock %}
