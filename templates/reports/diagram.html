{% extends "base.html" %}

{% block content %}
<div class="container-xxl">
    <div class="diagram-container">
        <h1>Diagrama de Jerarquía de Agentes</h1>
        <div id="tree-container"></div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.diagram-container {
    padding: 20px;
}

#tree-container {
    width: 100%;
    height: 600px;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: auto;
}

.node {
    cursor: pointer;
}

.node circle {
    fill: #fff;
    stroke: #1a73e8;
    stroke-width: 2px;
}

.node text {
    font: 12px sans-serif;
}

.link {
    fill: none;
    stroke: #ccc;
    stroke-width: 1.5px;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuración del diagrama
    const margin = {top: 20, right: 90, bottom: 30, left: 90};
    const width = 960 - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;

    // Crear el contenedor SVG
    const svg = d3.select("#tree-container")
        .append("svg")
        .attr("width", width + margin.right + margin.left)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    // Crear el layout del árbol
    const tree = d3.tree().size([height, width]);

    // Actualizar la URL para incluir el prefijo /reports/
    d3.json("/reports/api/agent-hierarchy").then(function(data) {
        // Crear la jerarquía
        const root = d3.hierarchy(data);
        
        // Asignar posiciones a los nodos
        tree(root);

        // Crear los enlaces
        const link = svg.selectAll(".link")
            .data(root.links())
            .enter().append("path")
            .attr("class", "link")
            .attr("d", d3.linkHorizontal()
                .x(d => d.y)
                .y(d => d.x));

        // Crear los nodos
        const node = svg.selectAll(".node")
            .data(root.descendants())
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.y},${d.x})`);

        // Agregar círculos a los nodos
        node.append("circle")
            .attr("r", 6);

        // Agregar texto a los nodos
        node.append("text")
            .attr("dy", ".31em")
            .attr("x", d => d.children ? -13 : 13)
            .style("text-anchor", d => d.children ? "end" : "start")
            .text(d => d.data.name);
    }).catch(function(error) {
        console.error("Error cargando los datos:", error);
        document.getElementById("tree-container").innerHTML = 
            "<p class='error'>Error al cargar el diagrama. Por favor, intente más tarde.</p>";
    });
});
</script>
{% endblock %}
